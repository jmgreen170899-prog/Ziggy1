name: Human E2E Verification

on:
  pull_request:
  workflow_dispatch:

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install backend dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install fastapi uvicorn
          fi

      - name: Start backend server
        env:
          DOCS_ENABLED: "true"
        run: |
          cd backend
          python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          echo $! > /tmp/backend.pid
          
      - name: Wait for backend health
        run: |
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:8000/health 2>/dev/null; then
              echo "Backend is healthy!"
              exit 0
            fi
            echo "Waiting for backend... ($elapsed/$timeout)"
            sleep 2
            elapsed=$((elapsed + 2))
          done
          echo "Backend failed to start within $timeout seconds"
          exit 1

      - name: Keep backend running
        run: |
          # Keep this job alive while frontend runs
          sleep 300 &
          wait

  frontend-and-crawl:
    runs-on: ubuntu-latest
    needs: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python (for backend)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install backend dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install fastapi uvicorn
          fi

      - name: Start backend server
        env:
          DOCS_ENABLED: "true"
        run: |
          cd backend
          python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          echo $! > /tmp/backend.pid

      - name: Wait for backend
        run: |
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:8000/health 2>/dev/null; then
              echo "Backend is healthy!"
              break
            fi
            echo "Waiting for backend... ($elapsed/$timeout)"
            sleep 2
            elapsed=$((elapsed + 2))
          done

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci || npm install

      - name: Build frontend
        run: |
          cd frontend
          npm run build || true

      - name: Start frontend preview server
        run: |
          cd frontend
          npx next start -p 5173 &
          echo $! > /tmp/frontend.pid

      - name: Wait for frontend
        run: |
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:5173 2>/dev/null; then
              echo "Frontend is ready!"
              break
            fi
            echo "Waiting for frontend... ($elapsed/$timeout)"
            sleep 2
            elapsed=$((elapsed + 2))
          done

      - name: Install Playwright
        run: |
          cd frontend
          npm run playwright:install

      - name: Run human crawler
        env:
          UI_URL: "http://localhost:5173"
          API_URL: "http://localhost:8000"
          SAFE_MODE: "true"
        run: |
          cd frontend
          node ./tests/verify.crawl.mjs

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts
          path: |
            frontend/tests/artifacts/**
            playwright-report
          retention-days: 7

      - name: Upload artifacts on success
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-trace
          path: |
            frontend/tests/artifacts/trace.zip
            frontend/tests/artifacts/report.json
          retention-days: 7

  summary:
    runs-on: ubuntu-latest
    needs: [frontend-and-crawl]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: e2e-trace
          path: artifacts
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "# Human E2E Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f artifacts/report.json ]; then
            echo "## Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            OPENAPI_COUNT=$(cat artifacts/report.json | jq -r '.openapiCount // 0')
            VISITED=$(cat artifacts/report.json | jq -r '.visited | join(", ")')
            CONSOLE_ERRORS=$(cat artifacts/report.json | jq -r '.consoleErrors | length')
            SERVER_5XX=$(cat artifacts/report.json | jq -r '.server5xx | length')
            
            echo "- **OpenAPI Paths**: $OPENAPI_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Pages Visited**: $VISITED" >> $GITHUB_STEP_SUMMARY
            echo "- **Console Errors**: $CONSOLE_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **5xx Endpoints**: $SERVER_5XX" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$CONSOLE_ERRORS" -gt 0 ]; then
              echo "### Console Errors" >> $GITHUB_STEP_SUMMARY
              cat artifacts/report.json | jq -r '.consoleErrors[]' | while read line; do
                echo "- $line" >> $GITHUB_STEP_SUMMARY
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$SERVER_5XX" -gt 0 ]; then
              echo "### 5xx Endpoints" >> $GITHUB_STEP_SUMMARY
              cat artifacts/report.json | jq -r '.server5xx[] | "- \(.path): \(.status)"' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$OPENAPI_COUNT" -ge 175 ] && [ "$CONSOLE_ERRORS" -eq 0 ] && [ "$SERVER_5XX" -eq 0 ]; then
              echo "✅ **All checks passed!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **Some checks failed**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⚠️ Report file not found" >> $GITHUB_STEP_SUMMARY
          fi
