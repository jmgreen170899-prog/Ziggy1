name: Human E2E Verification

on:
  pull_request:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install backend dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install fastapi uvicorn httpx numpy pandas sqlalchemy || pip install fastapi uvicorn

      - name: Start backend server
        env:
          DOCS_ENABLED: "true"
        run: |
          cd backend
          python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          echo $! > /tmp/backend.pid

      - name: Wait for backend health
        run: |
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:8000/health 2>/dev/null; then
              echo "✓ Backend is healthy!"
              break
            fi
            echo "Waiting for backend... ($elapsed/$timeout)"
            sleep 2
            elapsed=$((elapsed + 2))
          done
          if [ $elapsed -ge $timeout ]; then
            echo "✗ Backend failed to start"
            exit 1
          fi

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci || npm install

      - name: Build frontend
        run: |
          cd frontend
          npm run build || echo "Build failed, will use dev server"

      - name: Start frontend server
        run: |
          cd frontend
          # Try production server first, fallback to dev
          if [ -d .next ]; then
            npx next start -p 5173 &
          else
            PORT=5173 npm run dev &
          fi
          echo $! > /tmp/frontend.pid

      - name: Wait for frontend
        run: |
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:5173 2>/dev/null; then
              echo "✓ Frontend is ready!"
              break
            fi
            echo "Waiting for frontend... ($elapsed/$timeout)"
            sleep 2
            elapsed=$((elapsed + 2))
          done
          if [ $elapsed -ge $timeout ]; then
            echo "✗ Frontend failed to start"
            exit 1
          fi

      - name: Install Playwright
        run: |
          cd frontend
          npm run playwright:install

      - name: Run human crawler
        env:
          UI_URL: "http://localhost:5173"
          API_URL: "http://localhost:8000"
          SAFE_MODE: "true"
          MIN_OPENAPI_PATHS: "175"
        run: |
          cd frontend
          node ./tests/verify.crawl.mjs

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-verification-results
          path: |
            frontend/tests/artifacts/**
          retention-days: 7

      - name: Generate summary
        if: always()
        run: |
          echo "# Human E2E Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f frontend/tests/artifacts/report.json ]; then
            echo "## Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            OPENAPI_COUNT=$(cat frontend/tests/artifacts/report.json | jq -r '.openapiCount // 0')
            VISITED=$(cat frontend/tests/artifacts/report.json | jq -r '.visited | join(", ")')
            CONSOLE_ERRORS=$(cat frontend/tests/artifacts/report.json | jq -r '.consoleErrors | length')
            SERVER_5XX=$(cat frontend/tests/artifacts/report.json | jq -r '.server5xx | length')
            
            echo "- **OpenAPI Paths**: $OPENAPI_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Pages Visited**: $VISITED" >> $GITHUB_STEP_SUMMARY
            echo "- **Console Errors**: $CONSOLE_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **5xx Endpoints**: $SERVER_5XX" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$CONSOLE_ERRORS" -gt 0 ]; then
              echo "### Console Errors" >> $GITHUB_STEP_SUMMARY
              cat frontend/tests/artifacts/report.json | jq -r '.consoleErrors[]' | head -20 | while read line; do
                echo "- $line" >> $GITHUB_STEP_SUMMARY
              done
              if [ "$CONSOLE_ERRORS" -gt 20 ]; then
                echo "- ... and $((CONSOLE_ERRORS - 20)) more" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$SERVER_5XX" -gt 0 ]; then
              echo "### 5xx Endpoints" >> $GITHUB_STEP_SUMMARY
              cat frontend/tests/artifacts/report.json | jq -r '.server5xx[] | "- \(.path): \(.status)"' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "$OPENAPI_COUNT" -ge 175 ] && [ "$CONSOLE_ERRORS" -eq 0 ] && [ "$SERVER_5XX" -eq 0 ]; then
              echo "✅ **All checks passed!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **Some checks failed**" >> $GITHUB_STEP_SUMMARY
              if [ "$OPENAPI_COUNT" -lt 175 ]; then
                echo "  - OpenAPI paths: $OPENAPI_COUNT < 175" >> $GITHUB_STEP_SUMMARY
              fi
              if [ "$CONSOLE_ERRORS" -gt 0 ]; then
                echo "  - Console errors: $CONSOLE_ERRORS" >> $GITHUB_STEP_SUMMARY
              fi
              if [ "$SERVER_5XX" -gt 0 ]; then
                echo "  - 5xx endpoints: $SERVER_5XX" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "⚠️ Report file not found - crawler may not have completed" >> $GITHUB_STEP_SUMMARY
          fi
