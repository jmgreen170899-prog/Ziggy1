# Dependency Unification Plan

Goal: Use Poetry as the single source of truth for Python dependencies, generate deterministic requirements for Docker images and CI, and remove drift between `pyproject.toml` and `requirements.txt`.

## Steps

1) Adopt Poetry as canonical
- Ensure `backend/pyproject.toml` contains all runtime and dev dependencies.
- Add missing packages discovered in the code (e.g., `aiohttp`, `httpx`, `pytest`, `pytest-asyncio` if we reintroduce async tests, etc.).

2) Generate lock and export
- In backend folder, run:
  - `poetry lock` (update lock file)
  - `make freeze` (exports to `backend/requirements.txt`)
- Commit both `backend/pyproject.toml` and exported `backend/requirements.txt`.

3) Update Docker builds to use exported requirements
- `backend/Dockerfile` installs with `pip install -r requirements.txt` (generated by Poetry export).
- Keep `poetry` out of the container runtime unless needed for dev images.

4) CI: pin versions & cache
- Cache Poetry virtualenv and pip wheels by hash of `poetry.lock`.
- Run `poetry install --no-root` locally and in CI for typed/lint/test phases.

5) Remove drift
- Remove direct edits to `backend/requirements.txt` by developers; treat as generated.
- Add a simple pre-commit hook that fails if `requirements.txt` and `poetry.lock` are out of sync.

6) Optional: split groups
- Use Poetry dependency groups: `tool.poetry.group.dev`, `tool.poetry.group.test`, `tool.poetry.group.docs`.
- Export focused `requirements-test.txt` if you want slimmer CI images for tests.

## Quick Checklist
- [x] Ensure `aiohttp` present in `pyproject.toml` (used by RSS provider)
- [x] Ensure `httpx` present (providers)
- [x] Ensure `pandas`, `numpy` present (dataframes)
- [ ] Ensure `pytest`, `pytest-asyncio` (if needed)
- [x] Add `feedparser` if used; (added)
- [x] Align Python version in `pyproject.toml` with runtime base image (3.11)

## Rollout
- Phase 1 (Dev): use Poetry locally; keep Docker using `requirements.txt` exported.
- Phase 2 (CI): run tests with Poetry env; export `requirements.txt` in a dedicated job; build Docker from that artifact.
- Phase 3 (Cleanup): remove unreferenced dependencies and document the process in `implements/`.

## Current Status
- [x] Poetry dependencies updated to include backend runtime needs (aiohttp, sqlalchemy, pandas, pyarrow, yfinance, feedparser, dotenv, passlib).
- [x] Makefile `freeze` target exports to `backend/requirements.txt`.
- [x] `backend/Dockerfile` added to install from exported requirements.
- [ ] Run `poetry lock && make freeze` locally and commit the generated `requirements.txt`.
- [ ] Update CI to cache by `poetry.lock` and build Docker image using exported requirements.
